# 妖怪画像セグメンテーションツール 要件定義書

## 1. 目的
- 約4000枚の妖怪イラストを高速かつ安定して「妖怪（前景）」と「背景」にセグメンテーションし、透明PNGを生成する。
- モデル推論結果を人間が容易に確認し、承認／差戻し（Skip）／プロンプト修正による再推論を行える運用を確立する。

## 2. ステークホルダー
- **運用担当者**: 画像を確認し、承認/否認を行う。
- **開発者**: ツールの実装・保守を担当。
- **インフラ担当者**: クラウドGPU環境の準備・管理。

## 3. 対象範囲
- `yokai-gen/Preprocessing/segmentation` 以下のツール一式。
- 「Grounded-Segment-Anything」とGradioを用いた推論・UI処理。

## 4. 機能要件
1. **画像キュー管理**
   - `inputs/` の画像を順番に提示する。
   - 「Skip」で現在の画像をキューの末尾に移動。
   - 「Save」で `outputs/` に処理結果を書き出し、元画像を `processed/` へ移動。
2. **推論実行**
   - デフォルトプロンプト：`yokai, 妖怪, おばけ, 幽霊, ghost`。
   - 新しい画像が読み込まれるたびに、現在のプロンプトで自動推論。
   - ユーザーがプロンプト・閾値を編集し再実行可能。
3. **承認フロー**
   - プレビュー上の結果を確認し、「前景を残す」または「背景を残す」で保存。
   - 再推論→結果確認→承認/否認のループを高速に行えるUI。
4. **再処理**
   - 同じ画像に不満がある場合、プロンプト修正→再推論。
   - Skipした画像は物理移動せず論理的に最後尾キュー。

## 5. 非機能要件
- **性能**: 1画像あたりの推論時間を実用的な範囲（数秒〜十数秒）に抑える。GPU前提。
- **信頼性**: 途中で停止しても `processed/` への移動済み画像は再処理されないこと。
- **操作性**: 基本操作は承認・否認（Skip）・必要時のプロンプト編集のみ。
- **保守性**: Grounded-Segment-Anythingの標準構成を流用し、依存関係が明確であること。

## 6. 入出力要件
- **入力**: `inputs/` 配下の jpg/png/webp 等の画像ファイル（ファイル名はそのまま維持）。
- **出力**: `outputs/` に RGBA PNG（同名・拡張子のみ変換）。
- **ログ**: 標準出力に処理状況（ロード、保存、移動）を記録。

## 7. 制約条件
- CUDA対応GPU（クラウド）での実行。
- Grounded-Segment-Anything のライセンス遵守。
- 大量ファイル（約4000枚）に対応するため長時間稼働を想定。

## 8. 運用・サポート
- `setup.sh` により必要リポジトリ/重みを取得。
- READMEに従い `python src/app.py` でUIを起動。
- エラー発生時は標準出力ログを確認し、依存ライブラリやGPU環境を見直す。

## 9. 将来拡張（任意）
- バッチ自動化（人手確認なしで閾値を満たす場合に自動承認）。
- 画像メタデータ管理やDB連携。
- セグメンテーション結果の簡易編集ツール統合。

